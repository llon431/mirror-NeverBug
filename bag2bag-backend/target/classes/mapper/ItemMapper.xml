<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.bag2bag.st.mapper.ItemMapper">

    <!-- resultMap å°æ‡‰ Item å¯¦é«” -->
    <resultMap id="ItemMap" type="com.bag2bag.st.entity.Item">
        <id     column="id"            property="id"/>
        <result column="owner_id"      property="ownerId"/>
        <result column="title"         property="title"/>
        <result column="description"   property="description"/>
        <result column="category_id"   property="categoryId"/>

        <!-- Enum æ˜ å°„ -->
        <result column="condition"        property="condition"
                javaType="com.bag2bag.st.enums.ItemsCondition"/>
        <result column="transaction_type" property="transactionType"
                javaType="com.bag2bag.st.enums.TransactionType"/>
        <result column="status"           property="status"
                javaType="com.bag2bag.st.enums.ItemsStatus"/>

        <result column="price"          property="price"/>
        <result column="original_price" property="originalPrice"/>
        <result column="expected_price" property="expectedPrice"/>
        <result column="bought_date"    property="boughtDate"/>
        <result column="updated_at"       property="updatedAt"/>
        <result column="created_at"     property="createdAt"/>

        <!-- å°é¢åœ–ï¼Œåªæœ‰åœ¨ç‰¹å®šæŸ¥è©¢ SELECT å‡º cover_url æ™‚æ‰æœ‰å€¼ -->
        <result column="cover_url"      property="coverUrl"/>
    </resultMap>

    <!-- åŸºæœ¬æ¬„ä½ï¼ˆåªåŒ…å« items è¡¨è‡ªèº«çš„æ¬„ä½ï¼‰ -->
    <sql id="Base_Column_List">
        id, owner_id, title, description, category_id,
        `condition`, transaction_type,
        price, original_price, expected_price,
        bought_date, `status`,
        created_at, updated_at
    </sql>

    <!-- ä¾‹å­ï¼šæŸ¥å…¨éƒ¨ï¼ˆä¸å¸¶ cover_urlï¼‰ -->
    <select id="getAllItem" resultMap="ItemMap">
        SELECT <include refid="Base_Column_List"/>
        FROM items
    </select>

    <!-- ðŸ”¥ é¦–é æŸ¥è©¢ï¼šåªå– active å•†å“ + å°é¢åœ– -->
    <select id="selectActiveForHomepage" resultMap="ItemMap">
        SELECT
            i.id,
            i.owner_id,
            i.title,
            i.description,
            i.category_id,
            i.`condition`,
            i.transaction_type,
            i.price,
            i.original_price,
            i.expected_price,
            i.bought_date,
            i.`status`,
            i.created_at,
            i.updated_at,
            (
                SELECT p.url
                FROM item_photos p
                WHERE p.item_id = i.id
                ORDER BY p.sort_order ASC, p.id ASC
                LIMIT 1
            ) AS cover_url
        FROM items i
        WHERE i.`status` = 'active'
        ORDER BY i.created_at DESC
            LIMIT #{pageSize} OFFSET #{offset}
    </select>

    <!-- çµ±è¨ˆ active å•†å“ç¸½æ•¸ -->
    <select id="countActive" resultType="int">
        SELECT COUNT(*) FROM items WHERE `status` = 'active'
    </select>

</mapper>
